os: Windows Server 2012

# We need printf exponents to have 2 digits like the C standard says,
# or tests will fail. Set environment variable for mingw-w64:
# https://github.com/Alexpux/mingw-w64/blob/master/mingw-w64-crt/stdio/mingw_pformat.c#L223
environment:
  matrix:
  - PRINTF_EXPONENT_DIGITS: "2"

install:
  - set HOME=.
  - set MSYSTEM=MINGW64
  - set PATH=C:/msys64/usr/bin;C:/msys64/mingw64/bin;%PATH%
  - "sh -lc \"update-core\""
  - "sh -lc \"pacman -Su --noconfirm\""
  - "sh -lc \"pacman -S --noconfirm --needed
      mingw-w64-x86_64-openblas
      mingw-w64-x86_64-arpack
      mingw-w64-x86_64-gcc
      mingw-w64-x86_64-gcc-fortran
      mingw-w64-x86_64-ncurses
      mingw-w64-x86_64-readline
      mingw-w64-x86_64-netcdf
      diffutils
    \""

build_script:
  - sh -lc "mkdir bin/"
  - sh -lc "echo \"CPPTRAJBIN=$(pwd)/bin\" > config.h"
  - echo DBGFLAGS= >> config.h
  - echo CC=gcc >> config.h
  - echo CXX=g++ >> config.h
  - echo FC=gfortran >> config.h
  - echo CFLAGS=   -O3 -Wall -DHASBZ2 -DHASGZ -DBINTRAJ -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64 -I/usr/local/include -I/mingw64/include $(DBGFLAGS) >> config.h
  - echo CXXFLAGS= -O3 -Wall -DHASBZ2 -DHASGZ -DBINTRAJ -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64 -I/usr/local/include -I/mingw64/include $(DBGFLAGS) >> config.h
  - echo FFLAGS=   -O3       -DHASBZ2 -DHASGZ -DBINTRAJ -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64 -I/usr/local/include -I/mingw64/include -ffree-form $(DBGFLAGS) >> config.h
  - echo READLINE_TARGET=/mingw64/lib/libreadline.a >> config.h
  - echo READLINE_HOME=/mingw64/include/readline/ >> config.h
  - echo LIBCPPTRAJ=nolibcpptraj >> config.h
  - echo FFT_DEPEND=pub_fft.o >> config.h
  - echo FFT_LIB=pub_fft.o >> config.h
  - echo LDFLAGS=-lreadline -ltermcap -larpack -lnetcdf -lhdf5_hl -lhdf5 -lszip -lopenblas -lbz2 -lz  -lgfortran -lquadmath -w >> config.h
  - echo SFX=.exe>> config.h
  - sh -lc "cat config.h"
  - sh -lc "make -j2 install"


after_build:
  - 7z a cpptraj-%APPVEYOR_BUILD_ID%.zip bin/ambpdb.exe bin/cpptraj.exe
  - find C:/msys64/usr/local

test_script:
  - set TEST_OS=windows
  - sh -lc "cd test; make test.showerrors"

artifacts:
  - path: cpptraj-$(APPVEYOR_BUILD_ID).zip
